<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="./assets/imgs-logo-nobroke/noBroke-menor-sem-fundo.png">
  <title>Cadastro | noBroke </title>
</head>

<body class="background">

  <div class="container text-center">
    <div class="row align-items-center">
      <div class="col">
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput" class="form-label">
            <h6>Nome</h6>
          </label>
          <input type="text" class="form-control" id="nome_input" placeholder="Ex.: José Freitas">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Email</h6>
          </label>
          <input type="text" class="form-control" id="email_input" placeholder="Ex.: jose@empresa.com">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Senha</h6>
          </label>
          <input type="password" class="form-control" id="senha_input" placeholder="******">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Confirmar Senha</h6>
          </label>
          <input type="password" class="form-control" id="confirmacao_senha_input" placeholder="******">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Token de Ativação</h6>
          </label>
          <input type="text" class="form-control" id="token_input" placeholder="XXX-XXX-XXX">
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button class="btn btn-light button-color" type="button" onclick="cadastrar()">CADASTRE-SE</button>
        </div>
      </div>
      <div class="col">
        <img width="70%" src="./assets/imgs-logo-nobroke/noBroke-oficial-sem-fundo.png" alt="">
      </div>
    </div>
  </div>


</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>

  // Array para armazenar empresas cadastradas para validação de código de ativação 
  let listaEmpresasCadastradas = [];

  function cadastrar() {

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value.trim();
    var emailVar = email_input.value.trim();
    var senhaVar = senha_input.value.trim();
    var confirmacaoSenhaVar = confirmacao_senha_input.value.trim();
    var tokenVar = token_input.value.trim();
    var idEmpresaVincular

    console.log(nomeVar, emailVar, senhaVar, confirmacaoSenhaVar, tokenVar)

    // Verificando senha e email 
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      tokenVar == ""
    ) {
      alert("Mensagem de erro para todos os campos em branco");
    } else {

      let numeros = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
      let caractereEsperial = ['!', '@', '#', '"', '$', '%', '¨', '&', '*', '(', ')', '-', '+']
      let contemNumeros = false;
      let contemCaractereEspecial = false;

      for (i = 0; i < senhaVar.length; i++) {
        if (senhaVar.includes(numeros[i])) {
          contemNumeros = true;
          break;
        }
      }

      for (i = 0; i < senhaVar.length; i++) {
        if (senhaVar.includes(caractereEsperial[i])) {
          contemCaractereEspecial = true;
          break;
        }
      }

      let contemDominio = false;
      let finalPontoCom = false;

      for (i = 0; i < emailVar.length; i++) {
        if (emailVar.includes('@')) {
          contemDominio = true;
          break;
        }
      }
      
      for (i = 0; i < emailVar.length; i++) {
        if (emailVar.endsWith('.com')) {
          finalPontoCom = true;
          break;
        }
      }
      
      if (senhaVar < 8 ||
        senhaVar != confirmacaoSenhaVar ||
        contemNumeros == false ||
        contemCaractereEspecial == false ||
        contemDominio == false ||
        finalPontoCom == false
      ) {
        console.log('A senha deve ter mais que 8 caracteres. As senhas devem ser iguais. A senha deve conter caracteres especiais')
        
      } else {
        console.log('Cadastro ok')
        return false;
      }
    }
    
        // Verificando se o código de ativação é de alguma empresa cadastrada
        for (let i = 0; i < listaEmpresasCadastradas.length; i++) {
          if (listaEmpresasCadastradas[i].token_ativacao == tokenVar) {
            idEmpresaVincular = listaEmpresasCadastradas[i].id
            console.log("Código de ativação válido.");
            break;
          } else {
            cardErro.style.display = "block";
            mensagem_erro.innerHTML = "(Mensagem de erro para código inválido)";
            finalizarAguardar();
          }
        }
    
        // Enviando o valor da nova input
        fetch("/usuarios/cadastrar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            // crie um atributo que recebe o valor recuperado aqui
            // Agora vá para o arquivo routes/usuario.js
            nomeServer: nomeVar,
            emailServer: emailVar,
            senhaServer: senhaVar,
            idEmpresaVincularServer: idEmpresaVincular
          }),
        })
          .then(function (resposta) {
            console.log("resposta: ", resposta);
    
            if (resposta.ok) {
              cardErro.style.display = "block";
    
              mensagem_erro.innerHTML =
                "Cadastro realizado com sucesso! Redirecionando para tela de Login...";
    
              setTimeout(() => {
                window.location = "login.html";
              }, "2000");
    
              limparFormulario();
              finalizarAguardar();
            } else {
              throw "Houve um erro ao tentar realizar o cadastro!";
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            finalizarAguardar();
          });
    
        return false;
      }
    
      // Listando empresas cadastradas 
      function listar() {
        fetch("/empresas/listar", {
          method: "GET",
        })
          .then(function (resposta) {
            resposta.json().then((empresas) => {
              empresas.forEach((empresa) => {
                listaEmpresasCadastradas.push(empresa);
    
                console.log("listaEmpresasCadastradas")
                console.log(listaEmpresasCadastradas[0].token_ativacao)
              });
            });
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });
        
  }


</script>