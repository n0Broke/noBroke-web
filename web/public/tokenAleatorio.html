<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <title>token</title>
</head>

<body>
    <div>

        <select name="" id="select_opcao">
            <option value="#" selected disabled>Selecione</option>
            <option value="500">Infraestrutura</option>
            <option value="501">Gestor</option>
            <option value="502">DevOps</option>
        </select>

        <button onclick="selecionar()">Selecionar</button>

    </div>
    <br>

    <div id="div_resultado"></div>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>

<script>

    let codigo = '';

    function selecionar() {
       let opcao = select_opcao.value;

        let ultimoId_token = '';
   
        fetch(`/tokenAleatorio/buscarUltimo/:id`, {
            method: "GET",
        }).then((resposta) => {
            resposta.JSON().then((array_token) => {
                console.log('Estou aquiii')
                ultimoId_token = array_token[0].id_token + 1;
                console.log('Ultimo ID = ' + ultimoId_token )
            })
        })

        let listaCodigos = [];

        fetch(`/tokenAleatorio/listaCodigos/`, {
            method: "GET",
        }).then((resposta) => {
            resposta.JSON().then((codigos) => {
                codigos.forEach((codigo) => {
                    listaCodigos.push(codigo);

                    gerarCodigo();

                    // verifica se o código já existe na tabela ou não, caso exista ele reinicia a função
                    let codigoAprovado = false;

                    for (i = 0; i < listaCodigos.length; i++) {
                        if (codigo == listaCodigos[i]) {
                            selecionar();
                        } else {
                            codigoAprovado = true;
                        }
                    };

                    if (codigoAprovado) {
                        fetch(`/tokenAleatorio/cadastrarToken/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                idTokenNovo: ultimoId_token,
                                codigoNovo: codigo,
                                fk_cargo: opcao 
                        }),
                        })
                    }

                })

            })
        })

    }

    function gerarCodigo() {
        let letras = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        let numeros = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

        for (i = 0; i <= 10; i++) {
            codigo += letras[Math.floor(Math.random() * 27)];
            codigo += numeros[Math.floor(Math.random() * 11)];
        }
    }
</script>