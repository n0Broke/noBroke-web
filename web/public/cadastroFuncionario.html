<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="./assets/imgs-logo-nobroke/noBroke-menor-sem-fundo.png">
  <title>Cadastro | noBroke </title>
</head>

<body class="background">

  <div class="container text-center">
    <div class="row align-items-center">
      <div class="col">

        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput" class="form-label">
            <h6>Nível de Acesso*</h6>
          </label>
          <select id="select_nvlAcesso" class="form-select" aria-label="Default select example">
            <option value="#" selected disabled>Selecione uma opção</option>
            <option value="1">Administrador</option>
            <option value="2">Funcionário</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput" class="form-label">
            <h6>Nome*</h6>
          </label>
          <input type="text" class="form-control" id="nome_input" placeholder="Ex.: José Freitas">
        </div>

        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>CPF*</h6>
          </label>
          <input type="text" class="form-control" maxlength="11" id="cpf_input" placeholder="12345678911">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Email*</h6>
          </label>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="email_input" placeholder="Ex.: jose_2012@exemplo.com"
              aria-label="Recipient’s username" aria-describedby="basic-addon2">
            <!-- <span class="input-group-text" id="basic-addon2">@btgpactual.com</span> -->
          </div>
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Senha*</h6>
          </label>
          <input type="password" class="form-control" id="senha_input" placeholder="******">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Confirmar Senha*</h6>
          </label>
          <input type="password" class="form-control" id="confirmacao_senha_input" placeholder="******">
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button class="btn btn-light button-color" type="button" onclick="cadastrar()">CADASTRE-SE</button>
        </div>
      </div>
      <div class="col">
        <a href="index.html">
          <img width="70%" src="./assets/imgs-logo-nobroke/noBroke-oficial-sem-fundo.png" alt="">
        </a>

      </div>
    </div>
  </div>
  <div id="mensagem_erro"></div>


</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>


  function cadastrar() {

    let idEmpresa = sessionStorage.ID_EMPRESA;
    let idAdm = sessionStorage.ID_USUARIO;

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value.trim();
    var cpfVar = cpf_input.value.trim();
    var emailVar = email_input.value.trim();
    var senhaVar = senha_input.value.trim();
    var confirmacaoSenhaVar = confirmacao_senha_input.value.trim();
    var nvlAcessoVar = select_nvlAcesso.value.trim();

    console.log(nomeVar, emailVar, senhaVar, confirmacaoSenhaVar, cpfVar, nvlAcessoVar);

    // Verificando senha e email 
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      cpfVar == "" ||
      nvlAcessoVar == "#"
    ) {
      alert("Mensagem de erro para todos os campos em branco");
      return false;

    } else {

      // tratativa da senha 
      let numeros = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
      let caractereEsperial = ['!', '@', '#', '"', '$', '%', '¨', '&', '*', '(', ')', '-', '+'];
      let contemNumeros = false;
      let contemCaractereEspecial = false;

      for (var i = 0; i < senhaVar.length; i++) {
        if (senhaVar.includes(numeros[i])) {
          contemNumeros = true;
          break;
        }
      }

      for (var j = 0; j < senhaVar.length; j++) {
        if (senhaVar.includes(caractereEsperial[j])) {
          contemCaractereEspecial = true;
          break;
        }
      }

      // tratativa do email

      if (!emailVar.includes(".com")) {
        emailVar += ".com"
      }
      console.log(emailVar);

      possuiDominio = true;

      if (!emailVar.includes("@")) {
        possuiDominio = false;
      }

      //emailSplit = emailVar.split('@', 2)
      //emailVar = (emailSplit[0] + '@btgPactual.com')
      //console.log(emailSplit[0] + ' e ' + emailSplit[1] + ' passou para = ' + emailVar);


      // tratativa do nivel de Acesso
      if (nvlAcessoVar == "1") {
        nvlAcessoVar = "ADMIN";
      } else {
        nvlAcessoVar = "FUNCIONARIO";
      }

      // tratativa do cpf

      let cpfValido = false;

      if (!isNaN(cpfVar)) {

        let resultado = "";

        // descobrindo o D1
        let cont1 = 10;
        let somaD1 = 0;

        for (var k = 0; k < 9; k++) {
          let multiplicacaoD1 = cpfVar[k] * (cont1);

          somaD1 += multiplicacaoD1;

          cont1 -= 1;
        }

        let restoD1 = somaD1 % 11;

        if (restoD1 < 2) {
          restoD1 = 0;
          resultado += restoD1.toString();

        } else {
          restoD1 = 11 - restoD1;
          resultado += restoD1.toString();

        }


        // descobrindo o D2
        let cont2 = 11;

        let somaD2 = 0;


        for (var l = 0; l < 10; l++) {
          let multiplicacaoD2 = cpfVar[l] * (cont2);

          somaD2 += multiplicacaoD2;

          cont2 -= 1;
        }

        let restoD2 = somaD2 % 11;


        if (restoD2 < 2) {
          restoD2 = 0;
          resultado += restoD2.toString();

        } else {
          restoD2 = 11 - restoD2;
          resultado += restoD2.toString();

        }

        if (cpfVar[9] == resultado[0]
          && cpfVar[10] == resultado[1]) {
          cpfValido = true;

        } else {
          cpfValido = false;
        }

        console.log(resultado + cpfVar[9] + cpfVar[10])

      }



      if (senhaVar.length < 8 ||
        senhaVar != confirmacaoSenhaVar ||
        !contemNumeros ||
        !contemCaractereEspecial ||
        cpfVar.length > 11 ||
        !cpfValido ||
        !possuiDominio
      ) {
        console.log('A senha deve ter mais que 8 caracteres. As senhas devem ser iguais. A senha deve conter caracteres especiais')
        return false;

      } else {
        console.log('Cadastro ok');

        // Enviando o valor da nova input
        fetch("/cadastroFuncionario/cadastrar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            // crie um atributo que recebe o valor recuperado aqui
            // Agora vá para o arquivo routes/usuario.js
            nomeServer: nomeVar,
            emailServer: emailVar,
            senhaServer: senhaVar,
            cpfServer: cpfVar,
            nvlAcessoServer: nvlAcessoVar,
            idAdmServer: idAdmVar,
            empresaServer: idEmpresa
          }),
        })
          .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {

              mensagem_erro.innerHTML =
                "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

              setTimeout(() => {
                window.location = "login.html";
              }, "2000");


            } else {
              console.log(nomeServer, emailServer, senhaServer, cpfServer, idAdmServer, nvlAcessoServer, empresaServer)
              throw "Houve um erro ao tentar realizar o cadastro!";
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);

          });

        return false;

      }
    }

  }


</script>