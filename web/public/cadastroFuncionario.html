<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="./assets/imgs-logo-nobroke/noBroke-menor-sem-fundo.png">
  <title>Cadastro | noBroke </title>
</head>

<body class="background">

  <div class="container text-center">
    <div class="row align-items-center">
      <div class="col">
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput" class="form-label">
            <h6>Nome*</h6>
          </label>
          <input type="text" class="form-control" id="nome_input" placeholder="Ex.: José Freitas">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Email*</h6>
          </label>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="email_input" placeholder="Ex.: jose_2012"
              aria-label="Recipient’s username" aria-describedby="basic-addon2">
            <span class="input-group-text" id="basic-addon2">@btgpactual.com</span>
          </div>
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Senha*</h6>
          </label>
          <input type="password" class="form-control" id="senha_input" placeholder="******">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>Confirmar Senha*</h6>
          </label>
          <input type="password" class="form-control" id="confirmacao_senha_input" placeholder="******">
        </div>
        <div class="mb-3">
          <label class="label-title d-flex justify-content-start" for="formGroupExampleInput2" class="form-label">
            <h6>CPF*</h6>
          </label>
          <input type="text" class="form-control" id="cpf_input" placeholder="XXXXXXXXX-XX">
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button class="btn btn-light button-color" type="button" onclick="cadastrar()">CADASTRE-SE</button>
        </div>
      </div>
      <div class="col">
        <a href="index.html">
          <img width="70%" src="./assets/imgs-logo-nobroke/noBroke-oficial-sem-fundo.png" alt="">
        </a>

      </div>
    </div>
  </div>
  <div id="mensagem_erro"></div>


</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>


  function cadastrar() {
    id_funcionario = sessionStorage.ID_USUARIO = json.id;

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value.trim();
    var emailVar = email_input.value.trim();
    var senhaVar = senha_input.value.trim();
    var confirmacaoSenhaVar = confirmacao_senha_input.value.trim();
    var cpfVar = cpf_input.value.trim();

    console.log(nomeVar, emailVar, senhaVar, confirmacaoSenhaVar, cpfVar)

    // Verificando senha e email 
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" ||
      cpfVar == ""
    ) {
      alert("Mensagem de erro para todos os campos em branco");
      return false;

    } else {

      // trataiva da senha 
      let numeros = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
      let caractereEsperial = ['!', '@', '#', '"', '$', '%', '¨', '&', '*', '(', ')', '-', '+']
      let contemNumeros = false;
      let contemCaractereEspecial = false;

      for (i = 0; i < senhaVar.length; i++) {
        if (senhaVar.includes(numeros[i])) {
          contemNumeros = true;
          break;
        }
      }

      for (i = 0; i < senhaVar.length; i++) {
        if (senhaVar.includes(caractereEsperial[i])) {
          contemCaractereEspecial = true;
          break;
        }
      }

      // tratativa do email
      emailSplit = emailVar.split('@', 2)
      emailVar = (emailSplit[0] + '@btgPactual.com')

      console.log(emailSplit[0] + ' e ' + emailSplit[1] + ' passou para = ' + emailVar)

      // tratativa do cpf

      if (senhaVar < 8 ||
        senhaVar != confirmacaoSenhaVar ||
        !contemNumeros ||
        !contemCaractereEspecial
      ) {
        console.log('A senha deve ter mais que 8 caracteres. As senhas devem ser iguais. A senha deve conter caracteres especiais')
        return false;

      } else {
        console.log('Cadastro ok')
      }
    }

    fetch(`/token/buscar/${tokenSplit[0]}`, {
      method: "GET",
    }).then((resposta) => {
      resposta.json().then((array_token) => {
        console.log('Estou aqui buscando pelo id_token' + array_token[0].id_token)


        // Enviando o valor da nova input
        fetch("/usuarios/cadastrar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            // crie um atributo que recebe o valor recuperado aqui
            // Agora vá para o arquivo routes/usuario.js
            nomeServer: nomeVar,
            emailServer: emailVar,
            senhaServer: senhaVar,
            cpf: cpfVar
          }),
        })
          .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {

              mensagem_erro.innerHTML =
                "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

              setTimeout(() => {
                window.location = "login.html";
              }, "2000");


            } else {
              console.log(nomeServer, emailServer, senhaServer, idTokenVincularServer)
              throw "Houve um erro ao tentar realizar o cadastro!";
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);

          });

        return false;
      })

    })


  }


  /*
    // Array para armazenar Tokens cadastrados para validação de código de ativação 
  let listaTokensCadastrados = [];

      // Verificando se o código de ativação é de alguma empresa cadastrada
    // for (let i = 0; i < listaTokensCadastrados.length; i++) {
    //   console.log('estou no for listaToken')
    //   if (listaTokensCadastrados[i].token_ativacao == tokenSplit[0]) {
    //     idTokenVincular = listaTokensCadastrados[i].id
    //     console.log("Código de ativação válido.");
    //     break;
    //   } else {
    //     mensagem_erro.innerHTML = "(Mensagem de erro para código inválido)";
    //     
    //   }
    // }
  // Listando empresas cadastrados 
  function listar() {
    fetch("/token/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((tokens) => {
          token.forEach((token) => {
            listaTokensCadastrados.push(token);

            console.log("listaTokensCadastrados")
            console.log(listaTokensCadastrados[0].token_ativacao)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  */



</script>